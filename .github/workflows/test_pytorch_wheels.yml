name: Test PyTorch Wheels

on:
  workflow_dispatch:
    inputs:
      amdgpu_families:
        required: true
        type: string
        default: "gfx94X-dcgpu"
      python_version:
        required: true
        type: string
        default: "cp312-cp312"
      s3_bucket:
        required: true
        type: string
        default: "therock-nightly-python"
      s3_subdir:
        required: true
        type: string
        default: "v2"
      s3_cloudfront:
        required: true
        type: string
        default: "d2awnip2yjpvqn.cloudfront.net"
      test_runs_on:
        required: true
        type: string
        default: "linux-mi300-1gpu-ossci-rocm"

  workflow_call:
    inputs:
      amdgpu_families:
        required: true
        type: string
      python_version:
        required: true
        type: string
      s3_bucket:
        required: true
        type: string
      s3_subdir:
        required: true
        type: string
      s3_cloudfront:
        required: true
        type: string
      test_runs_on:
        required: true
        type: string

permissions:
  contents: read
  packages: write

jobs:
  test_wheels:
    name: Test PyTorch Wheels | ${{ inputs.amdgpu_families }}
    runs-on: ${{ inputs.test_runs_on }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Pull test container image
        run: docker pull ghcr.io/rocm/therock_build_manylinux_x86_64@sha256:044b113562629f4bd2ec5d2e64b32eee11562d48fb1a75d7493daec9dd8d8292

      - name: Run PyTorch installation and tests inside container
        run: |
          docker run --rm \
            --device=/dev/kfd \
            --device=/dev/dri \
            --group-add video \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            -e PYTORCH_TEST_WITH_ROCM=1 \
            ghcr.io/rocm/therock_build_manylinux_x86_64@sha256:044b113562629f4bd2ec5d2e64b32eee11562d48fb1a75d7493daec9dd8d8292 \
            bash -c "
              set -euxo pipefail

              # Set up python path
              python_dir=/opt/python/${{ inputs.python_version }}
              export PATH=\$python_dir/bin:\$PATH
              python_bin=\$python_dir/bin/python

              echo 'Python version:'
              \$python_bin --version
              which \$python_bin

              git config --global user.name 'therockbot'
              git config --global user.email 'therockbot@amd.com'

              # Clean and checkout repos
              cd /workspace/external-builds/pytorch/pytorch
              git am --abort || true
              git reset --hard
              git clean -xfd

              cd /workspace
              ./external-builds/pytorch/pytorch_torch_repo.py checkout
              ./external-builds/pytorch/pytorch_audio_repo.py checkout
              ./external-builds/pytorch/pytorch_vision_repo.py checkout

              # Install wheels from S3 index
              index_url='https://${{ inputs.s3_cloudfront }}/${{ inputs.s3_subdir }}/${{ inputs.amdgpu_families }}/'
              \$python_bin -m pip install --index-url \$index_url torch torchvision torchaudio

              # Also install wheel file if present in local workspace
              if compgen -G 'output/packages/dist/torch-*.whl' > /dev/null; then
                \$python_bin -m pip install output/packages/dist/torch-*.whl || true
              fi

              # Install test dependencies
              \$python_bin -m pip install pytest pytest-xdist numpy psutil

              echo 'Installed torch location:'
              \$python_bin -c 'import torch; print(torch.__file__)'

              rocm-smi || true

              # Run selected tests from source checkout
              cd /workspace/external-builds/pytorch/pytorch
              set +e
              EXIT_CODE=0
              for test_file in \
                test/test_nn.py \
                test/test_torch.py \
                test/test_cuda.py \
                test/test_ops.py \
                test/test_unary_ufuncs.py \
                test/test_binary_ufuncs.py \
                test/test_autograd.py \
                torch/_inductor/test_torchinductor.py; do
                  echo \"Running: \$test_file\"
                  \$python_bin -m pytest \$test_file -v --continue-on-collection-errors || EXIT_CODE=\$?
              done

              exit \$EXIT_CODE
            "
