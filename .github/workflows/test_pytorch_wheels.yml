name: Test PyTorch Wheels

on:
  workflow_dispatch:
    inputs:
      amdgpu_families:
        required: true
        type: string
        default: "gfx94X-dcgpu"
      python_version:
        required: true
        type: string
        default: "cp312-cp312"
      s3_bucket:
        description: "S3 bucket to upload the wheels"
        required: true
        type: string
        default: "therock-nightly-python"
      s3_subdir:
        description: "Subdirectory used in the bucket and CloudFront URL"
        required: true
        type: string
        default: "v2"
      s3_cloudfront:
        description: "CloudFront URL pointing to the bucket"
        required: true
        type: string
        default: "d2awnip2yjpvqn.cloudfront.net"
      test_runs_on:
        required: true
        type: string
        default: "linux-mi300-1gpu-ossci-rocm"

  workflow_call:
    inputs:
      amdgpu_families:
        required: true
        type: string
      python_version:
        required: true
        type: string
      s3_bucket:
        required: true
        type: string
      s3_subdir:
        required: true
        type: string
      s3_cloudfront:
        required: true
        type: string
      test_runs_on:
        required: true
        type: string

permissions:
  contents: read

jobs:
  test_wheels:
    name: Test PyTorch Wheels | ${{ inputs.amdgpu_families }}
    runs-on: ${{ inputs.test_runs_on }}

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Python
        uses: actions/setup-python@42375524e23c412d93fb67b49958b491fce71c38 # v5.4.0
        with:
          python-version: '3.12'

      - name: Debug directory contents
        run: |
          ls -la external-builds/pytorch/
          find . -name "*.sh"
          python3 --version
          which python3

      - name: Install dependencies
        env:
          PYTHON_VERSION: ${{ inputs.python_version }}
          INDEX_URL: https://${{ inputs.s3_cloudfront }}/${{ inputs.s3_subdir }}/${{ inputs.amdgpu_families }}/
        run: |
          bash external-builds/pytorch/install_linux_pytorch_deps.sh

      - name: Run PyTorch tests
        env:
          PYTHON_VERSION: ${{ inputs.python_version }}
        run: |
          bash external-builds/pytorch/run_linux_pytorch_tests.sh
