From 45af9b9798be9513c44310b8db7608bde6e4ea11 Mon Sep 17 00:00:00 2001
From: Stella Laurenzo <stellaraccident@gmail.com>
Date: Fri, 2 May 2025 15:27:13 -0700
Subject: [PATCH] Limit number of Tensile workers to 61 on Windows due to
 system limit.

---
 shared/tensile/Tensile/Parallel.py | 5 ++++-
 1 file changed, 4 insertions(+), 1 deletion(-)

diff --git a/shared/tensile/Tensile/Parallel.py b/shared/tensile/Tensile/Parallel.py
index a643c1aea3..f483d26466 100644
--- a/shared/tensile/Tensile/Parallel.py
+++ b/shared/tensile/Tensile/Parallel.py
@@ -36,7 +36,10 @@ def CPUThreadCount(enable=True):
         return 1
     else:
         if os.name == "nt":
-            cpu_count = os.cpu_count()
+            # Windows supports at most 61 workers because the scheduler uses
+            # WaitForMultipleObjects directly, which has the limit (the limit
+            # is actually 64, but some handles are needed for accounting).
+            cpu_count = min(os.cpu_count(), 61)
         else:
             cpu_count = len(os.sched_getaffinity(0))
         cpuThreads = globalParameters["CpuThreads"]
-- 
2.43.0

